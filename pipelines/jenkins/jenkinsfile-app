pipeline {
    agent { label 'jenkins-agent' }

    environment {
        DOCKERHUB_CREDENTIALS = 'dockerhub-creds'
        DOCKER_IMAGE = "narendra115c/cloud-architect-app"
        BUILD_META_URL = "http://build-metadata-service.trace.svc.cluster.local:8001/webhook/build"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                sh 'echo "Checked out repo:" && pwd && ls'
            }
        }

        stage('Collect Git Metadata') {
            steps {
                script {
                    def commitHash = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
                    def branch = env.GIT_BRANCH?.replace("origin/", "") ?: "unknown"
                    def repoName = sh(returnStdout: true, script: 'basename `git rev-parse --show-toplevel`').trim()
                    def triggeredBy = (env.BUILD_USER_ID ?: "jenkins")

                    env.CI_COMMIT_HASH  = commitHash
                    env.CI_BRANCH       = branch
                    env.CI_REPO         = repoName
                    env.CI_TRIGGERED_BY = triggeredBy
                }
            }
        }
        stage('Force Failure (Test)') {
    steps {
        sh 'exit 1'
            }
        }


        stage('Simulated Build (no Docker yet)') {
            steps {
                script {
                    def imageTag = "${DOCKER_IMAGE}:${env.BUILD_NUMBER}"
                    env.IMAGE_TAG = imageTag
                    echo "Simulating image build: ${imageTag}"
                }
            }
        }
    }

    // ðŸ”¥ THIS IS THE MOST IMPORTANT PART
    post {
        always {
            script {
                def startedAt = new Date(currentBuild.startTimeInMillis)
                    .format("yyyy-MM-dd'T'HH:mm:ssXXX", TimeZone.getTimeZone('UTC'))

                def finishedAt = new Date()
                    .format("yyyy-MM-dd'T'HH:mm:ssXXX", TimeZone.getTimeZone('UTC'))

                def payload = [
                    build_id     : "${env.JOB_NAME}#${env.BUILD_NUMBER}",
                    job_name     : env.JOB_NAME,
                    build_number : env.BUILD_NUMBER as int,
                    commit_hash  : env.CI_COMMIT_HASH ?: null,
                    repo         : env.CI_REPO ?: null,
                    branch       : env.CI_BRANCH ?: null,
                    status       : currentBuild.currentResult ?: "UNKNOWN",
                    triggered_by : env.CI_TRIGGERED_BY ?: "jenkins",
                    image_tag    : env.IMAGE_TAG ?: null,
                    jenkins_url  : env.BUILD_URL,
                    started_at   : startedAt,
                    finished_at  : finishedAt
                ]

                def json = groovy.json.JsonOutput.toJson(payload)

                sh """
                  curl -s -X POST '${BUILD_META_URL}' \
                    -H 'Content-Type: application/json' \
                    -d '${json}'
                """
            }

            echo "Build metadata sent with status: ${currentBuild.currentResult}"
        }
    }
}
